name: Pendle Stable APY Alert

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  alert:
    runs-on: ubuntu-latest
    steps:
      - name: Check Pendle Stablecoin Markets
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq curl

          echo "ðŸ“¡ Recupero mercati Pendle..."
          DATA=$(curl -s "https://api-v2.pendle.finance/core/v2/markets")

          RESULTS=$(echo "$DATA" | jq -r '
            .data[]
            | select(.underlyingSymbol | test("USDC|USDT|DAI|USDe|sUSDe"))
            | select(.impliedApy > 0.10)
            | "â€¢ \(.chain): \(.underlyingSymbol) | APY: \((.impliedApy * 100) | floor)% | Maturity: \(.maturityDate)"
          ')

          if [ -z "$RESULTS" ]; then
            MSG="Nessun mercato stablecoin Pendle con APY > 10% trovato oggi."
          else
            MSG="ðŸ“Š Mercati Pendle stablecoin con APY > 10%:\n$RESULTS"
          fi

          curl -s "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="$MSG" \
            -d parse_mode="Markdown"
