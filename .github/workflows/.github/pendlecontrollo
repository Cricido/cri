name: Pendle Stable APY Alert

on:
  schedule:
    - cron: '0 8 * * *' # ogni giorno alle 10:00 italiane
  workflow_dispatch:

jobs:
  alert:
    runs-on: ubuntu-latest
    steps:
      - name: Check Pendle Markets
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq curl

          echo "ðŸ“¡ Recupero mercati Pendle..."

          DATA=$(curl -s "https://api.pendle.finance/core/v2/markets")

          # Filtra mercati solo stable e con apy > 10
          RESULTS=$(echo "$DATA" | jq -r '
            .data[] 
            | select(.underlyingSymbol | test("USDC|USDT|DAI|USDe|sUSDe"))
            | select(.impliedApy > 0.10)
            | "\(.chain) | \(.underlyingSymbol) | APY: \(.impliedApy * 100)% | Maturity: \(.maturityDate)"
          ')

          if [ -z "$RESULTS" ]; then
            MSG="Nessun nuovo mercato Pendle stablecoin con APY > 10%."
          else
            MSG="ðŸ“Š Mercati Pendle stable con APY > 10%:\n$RESULTS"
          fi

          echo "$MSG"

          curl -s "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="$MSG" \
            -d parse_mode="Markdown"
