name: Morpho Steakhouse Telegram

on:
  schedule:
    - cron: '0 6 * * *'   # 08:00 CEST
    - cron: '0 11 * * *'  # 13:00 CEST
    - cron: '0 16 * * *'  # 18:00 CEST
    - cron: '0 21 * * *'  # 23:00 CEST
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Check Morpho APY & Send Telegram
        run: |
          sudo apt-get update && sudo apt-get install -y jq

          echo "ðŸ“¡ Recupero dati del vault Morpho Steakhouse USDT..."

          VAULT="0xbEef047a543E45807105E51A8BBEFCc5950fcfba"

          QUERY=$(cat <<'GRAPHQL'
          {
            "query": "query { vaultByAddress(address: \"0xbEef047a543E45807105E51A8BBEFCc5950fcfba\", chainId: 1) { state { totalAssetsUsd apy netApy } } }"
          }
GRAPHQL
          )

          # Richiesta a Morpho
          RESP=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "$QUERY" \
            https://api.morpho.org/graphql)

          echo "DEBUG: Risposta API: $RESP"

          TVL=$(echo "$RESP" | jq -r '.data.vaultByAddress.state.totalAssetsUsd')
          APY=$(echo "$RESP" | jq -r '.data.vaultByAddress.state.apy')
          NET_APY=$(echo "$RESP" | jq -r '.data.vaultByAddress.state.netApy')

          if [[ -z "$TVL" || "$TVL" == "null" ]]; then
            MSG="âŒ ERRORE: impossibile recuperare dati dal vault Morpho."
          else
            TVL_M=$(echo "$TVL/1000000" | bc -l | awk '{printf "%.2f", $0}')
            APY_PERC=$(echo "$APY * 100" | bc -l | awk '{printf "%.2f", $0}')
            NET_APY_PERC=$(echo "$NET_APY * 100" | bc -l | awk '{printf "%.2f", $0}')

            MSG="ðŸ“Š Morpho â€“ Steakhouse USDT\nTVL: ${TVL_M} M USD\nAPY lordo: ${APY_PERC}%\nAPY netto: ${NET_APY_PERC}%"
          fi

          echo "DEBUG: Messaggio finale: $MSG"

          # Invio messaggio Telegram
          curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.CHAT_ID }} \
            -d text="$MSG"
