name: APY & TVL Telegram Alert

on:
  schedule:
    - cron: '0 6 * * *'   # 08:00 CEST
    - cron: '0 11 * * *'  # 13:00 CEST
    - cron: '0 16 * * *'  # 18:00 CEST
    - cron: '0 21 * * *'  # 23:00 CEST
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Check APY & TVL, Telegram + Storico, Commit & Push
        run: |
          apt-get update && apt-get install -y jq

          echo "üì° Recupero APY da Beefy..."
          APY=$(curl -s https://api.beefy.finance/apy | jq -r '."stargate-v2-arb-usdt" // "error"')
          echo "DEBUG: APY grezzo: $APY"

          echo "üìä Recupero TVL da Vaults.fyi..."
          TVL=$(curl -s "https://api.vaults.fyi/v1/vaults/0xbEef047a543E45807105E51A8BBEFCc5950fcfBa" | jq -r '.tvlUsd // "error"')
          echo "DEBUG: TVL grezzo: $TVL"

          # Timestamp
          NOW=$(date '+%Y-%m-%d %H:%M:%S')

          # Verifica se ci sono errori nel recupero dati
          if [[ "$APY" == "error" || "$TVL" == "error" ]]; then
            echo "‚ùå Errore: Impossibile recuperare APY/TVL."
            curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
              -d chat_id=${{ secrets.CHAT_ID }} \
              -d text="‚ùå Errore: Impossibile recuperare APY/TVL a $NOW" \
              -d parse_mode="Markdown"
            exit 0  # Esci senza fallire il job
          fi

          # Verifica APY
          if [[ "$APY" == "error" || -z "$APY" || ! "$APY" =~ ^[0-9.]+$ ]]; then
            APY_MSG="‚ùå ERRORE: APY non valido ($APY)."
            APY_CSV="ERROR"
            APY_VALID=0
          else
            APY_INT=$(echo "$APY * 100" | bc -l | awk '{printf "%.2f", $0}')
            APY_DISPLAY=$(echo "$APY_INT" | sed 's/\./,/')
            APY_CSV=$APY_INT
            APY_VALID=1
          fi

          # Verifica TVL
          if [[ "$TVL" == "error" || -z "$TVL" || ! "$TVL" =~ ^[0-9.]+$ ]]; then
            TVL_MSG="‚ùå TVL non disponibile"
            TVL_CSV="ERROR"
            TVL_VALID=0
          else
            TVL_DISPLAY=$(printf "%'.2f" "$TVL")
            TVL_CSV=$(printf "%.2f" "$TVL")
            TVL_VALID=1
          fi

          # Soglie
          SOGLIA_APY=9.0
          SOGLIA_TVL=10000000

          # Messaggio APY
          if [[ "$APY_VALID" -eq 1 ]]; then
            if (( $(echo "$APY_INT < $SOGLIA_APY" | bc -l) )); then
              APY_MSG="‚ö†Ô∏è APY basso: ${APY_DISPLAY}%"
            else
              APY_MSG="‚úÖ APY OK: ${APY_DISPLAY}%"
            fi
          fi

          # Messaggio TVL
          if [[ "$TVL_VALID" -eq 1 ]]; then
            if (( $(echo "$TVL < $SOGLIA_TVL" | bc -l) )); then
              TVL_MSG="‚ö†Ô∏è TVL bassa: ${TVL_DISPLAY}‚ÄØUSD"
            else
              TVL_MSG="‚úÖ TVL OK: ${TVL_DISPLAY}‚ÄØUSD"
            fi
          fi

          # Messaggio finale
          MSG="üìà *Monitor Morpho Steakhouse USDT*\nüïí $NOW\n${APY_MSG}\n${TVL_MSG}"
          echo "DEBUG: $MSG"

          # Invia su Telegram
          curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.CHAT_ID }} \
            -d text="$MSG" \
            -d parse_mode="Markdown"

          # Scrive su CSV
          echo "DEBUG: Scrivo su storico.csv ‚Üí $NOW,$APY_CSV,$TVL_CSV"
          echo "$NOW,$APY_CSV,$TVL_CSV" >> storico.csv

          # Configura Git
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          # Commit
          git add storico.csv
          git commit -m "Aggiornamento APY/TVL $NOW" || echo "Nessuna modifica da committare"

          # Pull con rebase e gestione errori
          git pull --rebase origin main || (git rebase --abort && echo "Rebase fallito (possibile conflitto), skipping push" && exit 0)

          # Push
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main

      - name: Notify on Failure
        if: failure()
        run: |
          curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.CHAT_ID }} \
            -d text="‚ùå Workflow fallito: Controlla i log su GitHub" \
            -d parse_mode="Markdown"
