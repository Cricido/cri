name: Morpho TVL Telegram Alert

on:
  schedule:
    - cron: '0 7 * * *'   # 9:00 CEST ogni giorno
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Check TVL & Send Telegram
        run: |
          # Installa jq
          sudo apt-get update && sudo apt-get install -y jq

          echo "üì° Recupero TVL da Morpho..."

          # API Morpho Vault Steakhouse USDT (Ethereum)
          API_URL="https://blue-api.morpho.org/vaults/0xbEef047a543E45807105E51A8BBEFCc5950fcfBa"

          TVL=$(curl -s "$API_URL" | jq -r '.totalAssetsUsd // "error"')

          echo "DEBUG: TVL grezzo dall'API: $TVL"

          if [[ "$TVL" == "error" || -z "$TVL" ]]; then
            MSG="‚ùå ERRORE: impossibile recuperare il TVL del vault Steakhouse USDT."
          else
            MSG="üìä TVL Steakhouse USDT (Morpho Ethereum): ${TVL} USD"
          fi

          echo "DEBUG: Messaggio finale: $MSG"

          # Invia messaggio a Telegram usando gli stessi secrets del workflow APY
          curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.CHAT_ID }} \
            -d text="$MSG"
