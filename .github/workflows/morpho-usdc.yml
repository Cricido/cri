name: Morpho Steakhouse USDC (alt)

on:
  schedule:
    # GitHub Actions √® in UTC; a Roma: CET=UTC+1 / CEST=UTC+2
    - cron: "0 6 * * *"    # 07:00 CET / 08:00 CEST
    - cron: "0 11 * * *"   # 12:00 CET / 13:00 CEST
    - cron: "0 16 * * *"   # 17:00 CET / 18:00 CEST
    - cron: "0 21 * * *"   # 22:00 CET / 23:00 CEST
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      API_URL: "https://api.morpho.org/graphql"
      VAULT_ADDRESS: "0xBEEF01735c132Ada46AA9aA4c54623cAA92A64CB"  # Steakhouse USDC
      CHAIN_ID: 1
      TVL_THRESHOLD_USD: "20000000"    # valuta 50M se vuoi pi√π prudenza
      NET_APY_THRESHOLD: "0.04"        # 4% (decimale)
      # Fallback ai nomi dei secrets usati nello script USDT
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN || secrets.TELEGRAM_BOT_TOKEN || secrets.BOT_TOKEN }}
      CHAT_ID: ${{ secrets.CHAT_ID || secrets.TELEGRAM_CHAT_ID || secrets.CHANNEL_ID }}

    steps:
      - name: Setup tools
        shell: bash
        run: |
          set -Eeuo pipefail
          sudo apt-get update >/dev/null && sudo apt-get install -y jq bc gawk >/dev/null

      - name: Fetch Morpho data
        id: morpho
        shell: bash
        run: |
          set -Eeuo pipefail

          # Costruisci payload GraphQL
          QUERY=$(jq -n \
            --arg address "$VAULT_ADDRESS" \
            --arg q 'query($address: String!, $chainId: Int!) { vaultByAddress(address: $address, chainId: $chainId) { state { totalAssetsUsd apy netApy } } }' \
            --argjson chainId "$CHAIN_ID" \
            '{query:$q, variables:{address:$address, chainId:$chainId}}')

          # Chiamata API
          TMP="/tmp/morpho_usdc.json"
          HTTP_CODE=$(curl -sS --retry 3 --retry-delay 2 --max-time 20 \
            -H "Content-Type: application/json" \
            -d "$QUERY" \
            -o "$TMP" -w "%{http_code}" "$API_URL" || true)
          echo "HTTP Morpho: $HTTP_CODE"

          # Controlli base
          [[ -s "$TMP" ]] || { echo "‚ùå Nessun body ricevuto da Morpho"; exit 1; }
          jq -e 'has("errors") | not' "$TMP" >/dev/null || { echo "‚ùå GraphQL errors:"; jq '.errors' "$TMP"; exit 1; }
          jq -e '
            has("data") and
            .data|has("vaultByAddress") and
            .data.vaultByAddress|has("state") and
            (.data.vaultByAddress.state|has("totalAssetsUsd")) and
            (.data.vaultByAddress.state|has("apy")) and
            (.data.vaultByAddress.state|has("netApy"))
          ' "$TMP" >/dev/null || { echo "‚ùå Struttura inattesa"; cat "$TMP"; exit 1; }

          # Estrai valori grezzi
          TVL=$(jq -r '.data.vaultByAddress.state.totalAssetsUsd' "$TMP")
          APY=$(jq -r '.data.vaultByAddress.state.apy' "$TMP")
          NET_APY=$(jq -r '.data.vaultByAddress.state.netApy' "$TMP")

          # Formatta per il messaggio
          TVL_M=$(awk -v tvl="$TVL" 'BEGIN { printf("%.2f", tvl/1000000) }')
          APY_PERC=$(awk -v a="$APY" 'BEGIN { printf("%.2f", a*100) }')
          NET_APY_PERC=$(awk -v a="$NET_APY" 'BEGIN { printf("%.2f", a*100) }')

          # Valuta alert
          ALERTS=""
          if awk -v tvl="$TVL" -v thr="$TVL_THRESHOLD_USD" 'BEGIN { exit !(tvl < thr) }'; then
            ALERTS+="‚ö†Ô∏è <b>ALERT TVL</b>: sotto $(printf "%'.0f" "$TVL_THRESHOLD_USD") USD.<br/>"
          fi
          if awk -v a="$NET_APY" -v thr="$NET_APY_THRESHOLD" 'BEGIN { exit !(a < thr) }'; then
            ALERTS+="‚ö†Ô∏è <b>ALERT APY</b>: sotto $(awk -v t="$NET_APY_THRESHOLD" "BEGIN{printf(\"%.0f%%\", t*100)}").<br/>"
          fi

          STATUS="‚úÖ <b>Stato: Tutto OK</b>"
          ACTION=""
          if [[ -n "$ALERTS" ]]; then
            STATUS="‚ùå <b>Stato: Rischio Alto</b> üö®"
            ACTION="<b>Verifica su Morpho/Discord</b> e valuta withdraw."
          fi

          MSG="<b>Morpho ‚Äì Steakhouse USDC</b><br/>TVL: ${TVL_M} M USD<br/>APY lordo: ${APY_PERC}%<br/>APY netto: ${NET_APY_PERC}%<br/><br/>${ALERTS}${STATUS}"
          [[ -n "$ACTION" ]] && MSG="${MSG}<br/>${ACTION}"

          # Esponi output per lo step successivo
          {
            echo "TVL_M=$TVL_M"
            echo "APY_PERC=$APY_PERC"
            echo "NET_APY_PERC=$NET_APY_PERC"
            echo "MESSAGE<<EOF"
            echo "$MSG"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Send Telegram
        shell: bash
        run: |
          set -Eeuo pipefail

          # Controlli secrets (fallback gi√† in env)
          [[ -n "${TELEGRAM_TOKEN:-}" ]] || { echo "‚ùå Nessun token Telegram nei secrets"; exit 1; }
          [[ -n "${CHAT_ID:-}" ]] || { echo "‚ùå Nessun CHAT_ID nei secrets"; exit 1; }

          # Messaggio dall'output precedente
          MSG="${{ steps.morpho.outputs.MESSAGE }}"

          PAYLOAD=$(jq -n \
            --arg chat_id "$CHAT_ID" \
            --arg text "$MSG" \
            --arg mode "HTML" \
            '{chat_id:$chat_id, text:$text, parse_mode:$mode, disable_web_page_preview:true}')

          RESP=$(curl -sS --retry 3 --retry-delay 2 --max-time 20 \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage")

          echo "Telegram response:"; echo "$RESP" | jq .
          echo "$RESP" | jq -e '.ok == true' >/dev/null || { echo "‚ùå Invio Telegram fallito"; exit 1; }
