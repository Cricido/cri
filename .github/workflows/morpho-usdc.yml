    steps:
      - name: Check Morpho USDC & Send Telegram
        shell: bash
        run: |
          set -Eeuo pipefail

          sudo apt-get update >/dev/null && sudo apt-get install -y jq bc gawk >/dev/null

          echo "üì° Recupero dati dal vault Morpho Steakhouse USDC..."

          # Costruiamo il payload GraphQL senza read -d ''
          QUERY=$(jq -n \
            --arg address "$VAULT_ADDRESS" \
            --argjson chainId "$CHAIN_ID" \
            --arg q 'query($address: String!, $chainId: Int!) { vaultByAddress(address: $address, chainId: $chainId) { state { totalAssetsUsd apy netApy } } }' \
            '{query:$q, variables:{address:$address, chainId:$chainId}}')

          # Chiamata API con log HTTP e body salvato
          TMP="/tmp/morpho_resp.json"
          HTTP_CODE=$(curl -sS --retry 3 --retry-delay 2 --max-time 20 \
            -H "Content-Type: application/json" \
            -d "$QUERY" \
            -o "$TMP" -w "%{http_code}" "$API_URL" || true)

          echo "HTTP Morpho: $HTTP_CODE"
          if [[ ! -s "$TMP" ]]; then
            echo "‚ùå Nessun body ricevuto da Morpho."
            exit 1
          fi

          echo "DEBUG (estratto):"
          # Niente operatori // o ? ‚Äî compatibile ovunque
          if ! jq '{data: (if has("data") then .data else null end), errors: (if has("errors") then .errors else null end)}' "$TMP"; then
            echo "DEBUG (raw):"
            cat "$TMP"
          fi

          # Se GraphQL riporta errors, mostriamoli ed usciamo
          if jq -e 'has("errors") and (.errors | length > 0)' "$TMP" >/dev/null; then
            echo "‚ùå GraphQL errors:"
            jq '.errors' "$TMP"
            exit 1
          fi

          # Validazione campi
          if ! jq -e 'has("data")
                       and .data|has("vaultByAddress")
                       and .data.vaultByAddress|has("state")
                       and (.data.vaultByAddress.state|has("totalAssetsUsd"))
                       and (.data.vaultByAddress.state|has("apy"))
                       and (.data.vaultByAddress.state|has("netApy"))' "$TMP" >/dev/null; then
            echo "‚ùå Struttura inattesa o campi mancanti:"
            cat "$TMP"
            exit 1
          fi

          TVL=$(jq -r '.data.vaultByAddress.state.totalAssetsUsd' "$TMP")
          APY=$(jq -r '.data.vaultByAddress.state.apy' "$TMP")
          NET_APY=$(jq -r '.data.vaultByAddress.state.netApy' "$TMP")

          TVL_M=$(awk -v tvl="$TVL" 'BEGIN { printf("%.2f", tvl/1000000) }')
          APY_PERC=$(awk -v a="$APY" 'BEGIN { printf("%.2f", a*100) }')
          NET_APY_PERC=$(awk -v a="$NET_APY" 'BEGIN { printf("%.2f", a*100) }')

          ALERTS=""
          if awk -v tvl="$TVL" -v thr="$TVL_THRESHOLD_USD" 'BEGIN { exit !(tvl < thr) }'; then
            ALERTS+="‚ö†Ô∏è <b>ALERT TVL</b>: sotto 20M USD.<br/>"
          fi
          if awk -v a="$NET_APY" -v thr="$NET_APY_THRESHOLD" 'BEGIN { exit !(a < thr) }'; then
            ALERTS+="‚ö†Ô∏è <b>ALERT APY</b>: sotto 4%.<br/>"
          fi

          STATUS="‚úÖ <b>Stato: Tutto OK</b>"
          ACTION=""
          if [[ -n "$ALERTS" ]]; then
            STATUS="‚ùå <b>Stato: Rischio Alto</b> üö®"
            ACTION="<b>Verifica su Morpho/Discord</b> e valuta withdraw."
          fi

          MSG="<b>Morpho ‚Äì Steakhouse USDC</b><br/>TVL: ${TVL_M} M USD<br/>APY lordo: ${APY_PERC}%<br/>APY netto: ${NET_APY_PERC}%<br/><br/>${ALERTS}${STATUS}"
          [[ -n "$ACTION" ]] && MSG="${MSG}<br/>${ACTION}"

          TELEGRAM_API="https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage"
          PAYLOAD=$(jq -n \
            --arg chat_id "${{ secrets.CHAT_ID }}" \
            --arg text "$MSG" \
            --arg mode "HTML" \
            '{chat_id:$chat_id, text:$text, parse_mode:$mode, disable_web_page_preview:true}')

          curl -sS --retry 3 --retry-delay 2 --max-time 20 \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$TELEGRAM_API" \
            | jq -e '.ok == true' >/dev/null

          echo "‚úÖ Inviato"
