name: APY Telegram Alert

on:
  schedule:
    - cron: '0 7 * * *'  # ogni giorno alle 9:00 italiane
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Check APY & Send Telegram
        run: |
          echo "ðŸ“¡ Recupero APY da Beefy..."

          # APY in formato float esatto
          APY=$(curl -s https://api.beefy.finance/apy | jq -r '."stargate-v2-arb-usdt"')

          echo "ðŸ“ˆ APY ricevuto: $APY"

          # Converti in percentuale leggibile (es. 0.1458 â†’ 14.58%)
          APY_INT=$(echo "$APY * 100" | awk '{printf "%.2f", $1}')
          echo "âœ… APY convertito: $APY_INT%"

          SOGLIA=9.0

          if (( $(echo "$APY_INT < $SOGLIA" | bc -l) )); then
            MSG="âš ï¸ ALERT: L'APY del vault Beefy USDT Ã¨ sceso a ${APY_INT}%. Valuta se uscire."
          else
            MSG="âœ… APY OK: il vault rende ${APY_INT}%. Nessuna azione necessaria."
          fi

          curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.CHAT_ID }} \
            -d text="$MSG"
