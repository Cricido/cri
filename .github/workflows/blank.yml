name: APY Telegram Alert

on:
  schedule:
    - cron: '0 7 * * *'  # ogni giorno alle 9:00 italiane
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Check APY & Send Telegram
        run: |
          echo "Fetching APY..."
          RAW=$(curl -s https://api.beefy.finance/apy)
          APY=$(echo "$RAW" | grep -oP '"stargate-v2-arb-usdt":\K[0-9.]+')
          echo "APY ricevuto: $APY"

          APY_INT=$(echo "$APY * 100" | awk '{printf "%.2f", $1}')

          # Soglia: 9% = 0.09
          if [ "$(echo "$APY < 0.09" | awk '{print ($1 < 0.09) ? 1 : 0}')" -eq 1 ]; then
            MSG="⚠️ ALERT: L'APY è sceso a $APY_INT%"
          else
            MSG="✅ APY OK: $APY_INT%"
          fi

          curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.CHAT_ID }} \
            -d text="$MSG"
