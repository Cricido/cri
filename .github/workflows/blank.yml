name: APY Telegram Alert

on:
  schedule:
    - cron: '0 7 * * *'  # ogni giorno alle 9:00 italiane
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Check APY & Send Telegram
        run: |
          echo "📡 Recupero APY da Beefy..."

          # Recupera il valore dell'APY (es. 0.15 = 15%)
          RAW=$(curl -s https://api.beefy.finance/apy)
          APY=$(echo "$RAW" | grep -oP '"stargate-v2-arb-usdt":\K[0-9.]+')

          echo "📈 APY ricevuto: $APY"

          # Converti in percentuale con due decimali (es. 0.15 → 15.00)
          APY_INT=$(echo "$APY * 100" | awk '{printf "%.2f", $1}')
          echo "✅ APY convertito: $APY_INT%"

          # Soglia in percentuale decimale
          SOGLIA=9.0

          # Confronto e messaggio
          if (( $(echo "$APY_INT < $SOGLIA" | bc -l) )); then
            MSG="⚠️ ALERT: L'APY del vault Beefy USDT è sceso a ${APY_INT}%. Valuta se uscire."
          else
            MSG="✅ APY OK: il vault rende ${APY_INT}%. Nessuna azione necessaria."
          fi

          # Invia messaggio Telegram
          curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.CHAT_ID }} \
            -d text="$MSG"
